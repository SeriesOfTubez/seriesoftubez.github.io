<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Automating Azure AD B2B Invites with Approval Workflow – Page 3 – DefensiveSec</title>
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//s.w.org">


<link rel="stylesheet" id="wp-block-library-css" href="https://defensivesec.net/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="burger-factory-fonts-css" href="//fonts.googleapis.com/css?family=Roboto%3A300%2C400%2C400i%2C500%2C500i&ver=5.2.2" type="text/css" media="all">
<link rel="stylesheet" id="burger-factory-style-css" href="https://defensivesec.net/wp-content/themes/burger-factory/style.css" type="text/css" media="all">








		<style>
			.post-navigation .nav-previous::after
			{
				content: "Previous";
			}
			.post-navigation .nav-next::after
			{
				content: "Next";
			}

			p.site-description, .intro { color: #ffffff; }
			.sticky { border-left-color: #ffffff; }

			.front-page-category, .single .entry-meta, .single .entry-meta a { color: #00bca3; }
		</style>
	<link rel="icon" href="https://defensivesec.net/wp-content/uploads/2019/07/logo-150x150.png" sizes="32x32">
<link rel="icon" href="https://defensivesec.net/wp-content/uploads/2019/07/logo.png" sizes="192x192">
<link rel="apple-touch-icon-precomposed" href="https://defensivesec.net/wp-content/uploads/2019/07/logo.png">
<meta name="msapplication-TileImage" content="https://defensivesec.net/wp-content/uploads/2019/07/logo.png">
</head>

<body class="post-template-default single single-post postid-18 single-format-standard paged-3 single-paged-3 color-scheme-dark">
	<div id="site-wrapper">
	<div id="page" class="site container">
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

		<header id="masthead" class="row site-header" role="banner">
			<div class="col-12">
									<p class="site-title"><a href="https://defensivesec.net/" rel="home">DefensiveSec</a></p>
									<p class="site-description">A website for sharing defensive security knowledge.</p>
							</div>
		</header>

		<div id="content" class="site-content">
            
	<div id="primary" class="content-area">
		<main id="main" class="site-main row" role="main">
		<div class="col-3 sidebar">
			<nav id="site-navigation" class="main-navigation" role="navigation">
    <div id="primary-menu" class="menu"></div>
</nav>

<aside id="secondary" class="widget-area" role="complementary">
			<section id="recent-posts-2" class="widget widget_recent_entries">		<h2 class="widget-title">Recent Posts</h2>		<ul>
											<li>
					<a href="https://defensivesec.net/2019/07/18/automating-azure-ad-b2b-invites-with-approval-workflow/">Automating Azure AD B2B Invites with Approval Workflow</a>
									</li>
											<li>
					<a href="https://defensivesec.net/2019/07/18/disappearing-windows-10-event-logs-after-feature-update/">Disappearing Windows 10 Event Logs After Feature Update</a>
									</li>
					</ul>
		</section><section id="archives-2" class="widget widget_archive"><h2 class="widget-title">Archives</h2>		<ul>
				<li><a href="https://defensivesec.net/2019/07/">July 2019</a></li>
		</ul>
			</section><section id="categories-2" class="widget widget_categories"><h2 class="widget-title">Categories</h2>		<ul>
				<li class="cat-item cat-item-7"><a href="https://defensivesec.net/category/automation/">Automation</a>
</li>
	<li class="cat-item cat-item-9"><a href="https://defensivesec.net/category/azure/">Azure</a>
</li>
	<li class="cat-item cat-item-6"><a href="https://defensivesec.net/category/azure/azure-ad/">Azure AD</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://defensivesec.net/category/dfir/">DFIR</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://defensivesec.net/category/endpoint/">Endpoint</a>
</li>
	<li class="cat-item cat-item-2"><a href="https://defensivesec.net/category/logging/">Logging</a>
</li>
	<li class="cat-item cat-item-8"><a href="https://defensivesec.net/category/o365/">O365</a>
</li>
	<li class="cat-item cat-item-5"><a href="https://defensivesec.net/category/windows/">Windows</a>
</li>
		</ul>
			</section></aside>		</div>
		<div class="col-9">
			
				<article id="post-18" class="post-18 post type-post status-publish format-standard hentry category-automation category-azure category-azure-ad category-o365">

					<div class="post-thumbnail">
											</div>

					<header class="entry-header">
												<div class="entry-meta">
							<span class="posted-on"><time class="entry-date published updated" datetime="2019-07-18T20:55:52-05:00">July 18, 2019</time></span>							<span class="cat-links"><a href="https://defensivesec.net/category/automation/" rel="category tag">Automation</a>, <a href="https://defensivesec.net/category/azure/" rel="category tag">Azure</a>, <a href="https://defensivesec.net/category/azure/azure-ad/" rel="category tag">Azure AD</a>, <a href="https://defensivesec.net/category/o365/" rel="category tag">O365</a></span>						</div>
												<h1 class="entry-title">Automating Azure AD B2B Invites with Approval Workflow</h1></header>

					<div class="entry-content">
						


<p>We now have an object (possibly blank) that we can use to determine if the user exists.  We need to add a Condition Control to split our Flow depending on the result.  Add an expression and use the definition below to check if the returned object is empty.  </p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0021.png" alt="" class="wp-image-51" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0021.png 601w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0021-300x81.png 300w" sizes="(max-width: 601px) 100vw, 601px"></figure>



<pre class="wp-block-code"><code>empty(body('Parse_User_Check')?['value'])</code></pre>



<p>In the No branch, we’ll just send the requester a notification since the user already exists.  I’m using the Office 365 <strong>Send an Email</strong> action to send emails.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0017.png" alt="" class="wp-image-52" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0017.png 645w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0017-300x178.png 300w" sizes="(max-width: 645px) 100vw, 645px"></figure>



<p>In the Yes branch, we’ll kick off the rest of our Flow.  In my approval process, I send the approval request to the requester’s manager.  So, we need to request an object for their manager.  Add another HTTP action.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0016-1.png" alt="" class="wp-image-55" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0016-1.png 609w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0016-1-300x182.png 300w" sizes="(max-width: 609px) 100vw, 609px"></figure>



<p>Then of course, we need to parse the response so we can work with the values.  Add another Parse JSON action, using the <strong>Body</strong> of the <strong>Get Requester’s Manager</strong> action.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0014.png" alt="" class="wp-image-54" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0014.png 615w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0014-300x165.png 300w" sizes="(max-width: 615px) 100vw, 615px"></figure>



<pre class="wp-block-code"><code>{
    "type": "object",
    "properties": {
        "@@odata.context": {
            "type": "string"
        },
        "@@odata.type": {
            "type": "string"
        },
        "id": {
            "type": "string"
        },
        "businessPhones": {
            "type": "array",
            "items": {
                "type": "string"
            }
        },
        "displayName": {
            "type": "string"
        },
        "givenName": {
            "type": "string"
        },
        "jobTitle": {},
        "mail": {
            "type": "string"
        },
        "mobilePhone": {},
        "officeLocation": {},
        "preferredLanguage": {
            "type": "string"
        },
        "surname": {
            "type": "string"
        },
        "userPrincipalName": {
            "type": "string"
        }
    }
}</code></pre>



<p>Let’s go ahead and setup an approval condition.  Add a <strong>Start and wait for an approval</strong> action.  The <strong><em>mail</em></strong> value in <strong>Assigned to</strong> is parsed from the Manager object.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0013.png" alt="" class="wp-image-56" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0013.png 614w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0013-300x211.png 300w" sizes="(max-width: 614px) 100vw, 614px"></figure>



<p>Next, let’s add another Condition Control to branch our Flow depending on the approval outcome.  We’re checking if the <strong><em>Response</em></strong> value from the <strong>Get Manager Approval</strong> action is <strong><em>Approve</em></strong>.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0052.png" alt="" class="wp-image-58" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0052.png 604w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0052-300x82.png 300w" sizes="(max-width: 604px) 100vw, 604px"></figure>



<p>In the NO branch, we’ll just send the requester an email saying they’ve been DENIED!</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0008.png" alt="" class="wp-image-59" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0008.png 643w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0008-300x189.png 300w" sizes="(max-width: 643px) 100vw, 643px"></figure>



<p>In the YES branch, we’ll finish off our Flow.  We’re almost done! Add a new HTTP action.  This will be an API call to the Microsoft Graph API to send an invite to the guest email address.  Body content provided below, just replace the <> values with dynamic values like shown below.  Make sure to also set the appropriate redirect URL.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0011.png" alt="" class="wp-image-60" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0011.png 637w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0011-281x300.png 281w" sizes="(max-width: 637px) 100vw, 637px"></figure>



<pre class="wp-block-code"><code>{
  "inviteRedirectUrl": "https://www.yourdomain.tld",
  "invitedUserEmailAddress": "<Guest Email Address>",
  "sendInvitationMessage": true,
  "invitedUserDisplayName": "<Guest Name>",
  "invitedUserMessageInfo": {
    "customizedMessageBody": "Hello <Guest Name>, You have been invited by <responder email address> as a guest.  Continuing will allow you to collaborate and access data shared with you."
  }
}</code></pre>



<p>Now, once again, let’s parse the invite response.  Add a new Parse JSON action and use the body from the HTTP action above as the content.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0010.png" alt="" class="wp-image-61" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0010.png 606w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0010-300x168.png 300w" sizes="(max-width: 606px) 100vw, 606px"></figure>



<pre class="wp-block-code"><code>{
    "properties": {
        "@@odata.context": {
            "type": "string"
        },
        "id": {
            "type": "string"
        },
        "inviteRedeemUrl": {
            "type": "string"
        },
        "inviteRedirectUrl": {
            "type": "string"
        },
        "invitedUser": {
            "properties": {
                "id": {
                    "type": "string"
                }
            },
            "type": "object"
        },
        "invitedUserDisplayName": {},
        "invitedUserEmailAddress": {
            "type": "string"
        },
        "invitedUserMessageInfo": {
            "properties": {
                "ccRecipients": {
                    "items": {
                        "properties": {
                            "emailAddress": {
                                "properties": {
                                    "address": {},
                                    "name": {}
                                },
                                "type": "object"
                            }
                        },
                        "required": [
                            "emailAddress"
                        ],
                        "type": "object"
                    },
                    "type": "array"
                },
                "customizedMessageBody": {},
                "messageLanguage": {}
            },
            "type": "object"
        },
        "invitedUserType": {
            "type": "string"
        },
        "sendInvitationMessage": {
            "type": "boolean"
        },
        "status": {
            "type": "string"
        }
    },
    "type": "object"
}</code></pre>



<p>Finally, we just need to send the requester an email letting them know that their request was approved and processed.  We’ll use an Office 365 <strong>Send an Email</strong> action.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0009.png" alt="" class="wp-image-62" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0009.png 606w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0009-300x177.png 300w" sizes="(max-width: 606px) 100vw, 606px"></figure>



<p>To test, fill out the form.</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0005.png" alt="" class="wp-image-66" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0005.png 788w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0005-300x270.png 300w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0005-768x691.png 768w" sizes="(max-width: 788px) 100vw, 788px"></figure>



<p>

 Your manager (or whoever you decide to assign the approval to) should get a request to approve.

</p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0002-1024x294.png" alt="" class="wp-image-67" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0002-1024x294.png 1024w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0002-300x86.png 300w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0002-768x220.png 768w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0002.png 1092w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>If approved, you should see the new account show up in Azure AD as an “Invited User”. </p>



<figure class="wp-block-image"><img src="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0000-1024x35.png" alt="" class="wp-image-65" srcset="https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0000-1024x35.png 1024w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0000-300x10.png 300w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0000-768x27.png 768w,https://defensivesec.net/wp-content/uploads/2019/07/GuestUser-0000.png 1159w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p> Once the user completes the invitation, that will change to whatever account type that user has.</p>
<div class="page-links">Pages: <a href="https://defensivesec.net/2019/07/18/automating-azure-ad-b2b-invites-with-approval-workflow/" class="post-page-numbers">1</a> <a href="https://defensivesec.net/2019/07/18/automating-azure-ad-b2b-invites-with-approval-workflow/2/" class="post-page-numbers">2</a> <span class="post-page-numbers current" aria-current="page">3</span></div>					</div>

					<footer class="entry-footer">
											</footer>
				</article>

				
	<nav class="navigation post-navigation" role="navigation">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://defensivesec.net/2019/07/18/disappearing-windows-10-event-logs-after-feature-update/" rel="prev">Disappearing Windows 10 Event Logs After Feature Update</a></div></div>
	</nav>		</div>
		</main>

	</div>

        
	</div>

	<footer id="colophon" class="site-footer row" role="contentinfo">
		<div class="col-3">
		</div>
		<div class="col-9 site-info">
			<p></p>
			<p class="theme-by really-small"><a href="https://anguswoodman.com/simple-wordpress-themes" rel="designer">Theme by Angus Woodman</a></p>
		</div>
	</footer>
</div>


</div></body>
</html>
