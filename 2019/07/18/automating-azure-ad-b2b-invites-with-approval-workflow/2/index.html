<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Automating Azure AD B2B Invites with Approval Workflow – Page 2 – DefensiveSec</title>
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//s.w.org">


<link rel="stylesheet" id="wp-block-library-css" href="http://www.defensivesec.net/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="burger-factory-fonts-css" href="//fonts.googleapis.com/css?family=Roboto%3A300%2C400%2C400i%2C500%2C500i&ver=5.2.2" type="text/css" media="all">
<link rel="stylesheet" id="burger-factory-style-css" href="http://www.defensivesec.net/wp-content/themes/burger-factory/style.css" type="text/css" media="all">








		<style>
			.post-navigation .nav-previous::after
			{
				content: "Previous";
			}
			.post-navigation .nav-next::after
			{
				content: "Next";
			}

			p.site-description, .intro { color: #ffffff; }
			.sticky { border-left-color: #ffffff; }

			.front-page-category, .single .entry-meta, .single .entry-meta a { color: #00bca3; }
		</style>
	<link rel="icon" href="http://www.defensivesec.net/wp-content/uploads/2019/07/logo-150x150.png" sizes="32x32">
<link rel="icon" href="http://www.defensivesec.net/wp-content/uploads/2019/07/logo.png" sizes="192x192">
<link rel="apple-touch-icon-precomposed" href="http://www.defensivesec.net/wp-content/uploads/2019/07/logo.png">
<meta name="msapplication-TileImage" content="http://www.defensivesec.net/wp-content/uploads/2019/07/logo.png">
</head>

<body class="post-template-default single single-post postid-18 single-format-standard paged-2 single-paged-2 color-scheme-dark">
	<div id="site-wrapper">
	<div id="page" class="site container">
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

		<header id="masthead" class="row site-header" role="banner">
			<div class="col-12">
									<p class="site-title"><a href="http://www.defensivesec.net/" rel="home">DefensiveSec</a></p>
									<p class="site-description">A website for sharing defensive security knowledge.</p>
							</div>
		</header>

		<div id="content" class="site-content">
            
	<div id="primary" class="content-area">
		<main id="main" class="site-main row" role="main">
		<div class="col-3 sidebar">
			<nav id="site-navigation" class="main-navigation" role="navigation">
    <div id="primary-menu" class="menu"></div>
</nav>

<aside id="secondary" class="widget-area" role="complementary">
			<section id="recent-posts-2" class="widget widget_recent_entries">		<h2 class="widget-title">Recent Posts</h2>		<ul>
											<li>
					<a href="http://www.defensivesec.net/2019/07/18/automating-azure-ad-b2b-invites-with-approval-workflow/">Automating Azure AD B2B Invites with Approval Workflow</a>
									</li>
											<li>
					<a href="http://www.defensivesec.net/2019/07/18/disappearing-windows-10-event-logs-after-feature-update/">Disappearing Windows 10 Event Logs After Feature Update</a>
									</li>
					</ul>
		</section><section id="archives-2" class="widget widget_archive"><h2 class="widget-title">Archives</h2>		<ul>
				<li><a href="http://www.defensivesec.net/2019/07/">July 2019</a></li>
		</ul>
			</section><section id="categories-2" class="widget widget_categories"><h2 class="widget-title">Categories</h2>		<ul>
				<li class="cat-item cat-item-7"><a href="http://www.defensivesec.net/category/automation/">Automation</a>
</li>
	<li class="cat-item cat-item-9"><a href="http://www.defensivesec.net/category/azure/">Azure</a>
</li>
	<li class="cat-item cat-item-6"><a href="http://www.defensivesec.net/category/azure/azure-ad/">Azure AD</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://www.defensivesec.net/category/dfir/">DFIR</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://www.defensivesec.net/category/endpoint/">Endpoint</a>
</li>
	<li class="cat-item cat-item-2"><a href="http://www.defensivesec.net/category/logging/">Logging</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://www.defensivesec.net/category/o365/">O365</a>
</li>
	<li class="cat-item cat-item-5"><a href="http://www.defensivesec.net/category/windows/">Windows</a>
</li>
		</ul>
			</section></aside>		</div>
		<div class="col-9">
			
				<article id="post-18" class="post-18 post type-post status-publish format-standard hentry category-automation category-azure category-azure-ad category-o365">

					<div class="post-thumbnail">
											</div>

					<header class="entry-header">
												<div class="entry-meta">
							<span class="posted-on"><time class="entry-date published updated" datetime="2019-07-18T20:55:52-05:00">July 18, 2019</time></span>							<span class="cat-links"><a href="http://www.defensivesec.net/category/automation/" rel="category tag">Automation</a>, <a href="http://www.defensivesec.net/category/azure/" rel="category tag">Azure</a>, <a href="http://www.defensivesec.net/category/azure/azure-ad/" rel="category tag">Azure AD</a>, <a href="http://www.defensivesec.net/category/o365/" rel="category tag">O365</a></span>						</div>
												<h1 class="entry-title">Automating Azure AD B2B Invites with Approval Workflow</h1></header>

					<div class="entry-content">
						


<p>Ok – Now back to the Flow!</p>



<p>So far, all we’ve done in the Flow is add the Form trigger and choose our Form.  Now we need to add all of our actions.  The first thing we need to do is create three variables to store our Tenant ID, Application ID and Application Secret.  These were all provided when we created our Registered App in Azure AD.</p>



<p>Add a new step and find the <strong>Initialize a Variable</strong> action.  Now do that two more times. Fill in the values like shown below.  </p>



<figure class="wp-block-image"><img src="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0032.png" alt="" class="wp-image-42" srcset="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0032.png 604w,http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0032-300x279.png 300w" sizes="(max-width: 604px) 100vw, 604px"></figure>



<p style="color:#2bbc8a" class="has-text-color">NOTE: To make your Flow easy to read, you should click on the elipsis (…) on each item and rename it to something useful.  Doing this after you’ve already created your Flow will break things so do it as you add items.</p>



<p>Now we want to get the response details from the submitted form.  Add a Get response details action and choose the form and details to grab.</p>



<figure class="wp-block-image"><img src="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0031.png" alt="" class="wp-image-43" srcset="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0031.png 553w,http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0031-300x188.png 300w" sizes="(max-width: 553px) 100vw, 553px"></figure>



<figure class="wp-block-image"><img src="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0030.png" alt="" class="wp-image-44" srcset="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0030.png 640w,http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0030-300x144.png 300w" sizes="(max-width: 640px) 100vw, 640px"></figure>



<p>The next thing we’re going to do is authenticate to the Microsoft Graph API and get an access token.  The access token will be used every time we make a call to the Microsoft Graph API</p>



<p>Add an action directly after the <strong>Get response details</strong> and choose <strong>HTTP</strong></p>



<figure class="wp-block-image"><img src="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0029.png" alt="" class="wp-image-45" srcset="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0029.png 594w,http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0029-300x181.png 300w" sizes="(max-width: 594px) 100vw, 594px"></figure>



<p>Make it look like the image above.  We’re crafting an API call to the Microsoft Graph API to get an access token.  I’ll include the body text below, just modify the variable names if you used something different.</p>



<pre class="wp-block-code"><code>client_id=@{variables('AppID')}&client_secret=@{variables('AppSecret')}&grant_type=client_credentials&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default</code></pre>



<p>Now, we need to parse the JSON response that the Microsoft Graph API returns so we can use the values later.  Add another action and choose the <strong>Parse JSON</strong> action.  For the Content, choose the <strong>Body</strong> from the <strong>Get Access Token</strong> action.  I’ve included the full Schema below as well.</p>



<figure class="wp-block-image"><img src="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0051.png" alt="" class="wp-image-47" srcset="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0051.png 608w,http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0051-300x164.png 300w" sizes="(max-width: 608px) 100vw, 608px"></figure>



<pre class="wp-block-code"><code>{
    "properties": {
        "access_token": {
            "type": "string"
        },
        "expires_in": {
            "type": "integer"
        },
        "ext_expires_in": {
            "type": "integer"
        },
        "token_type": {
            "type": "string"
        }
    },
    "type": "object"
}</code></pre>



<p>Now that we have our access token, we’re going to check to see if the user being requested already exists in the Azure AD tenant.  If so, there is no need to proceed with requesting approvals.  We’ll just notify the requester that the users already exists.</p>



<p>Add another HTTP action, this time we’re calling the Microsoft Graph API to check if an account with the same email address already exists.  Make your HTTP action look like the one below.</p>



<figure class="wp-block-image"><img src="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0024.png" alt="" class="wp-image-49" srcset="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0024.png 607w,http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0024-300x170.png 300w" sizes="(max-width: 607px) 100vw, 607px"></figure>



<p>Now we need to parse the response that is returned.  Add another <strong>Parse JSON</strong> action and use the <strong>Body</strong> of the <strong>Check if User Exists</strong> action as the content.  I included the schema below.</p>



<figure class="wp-block-image"><img src="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0023.png" alt="" class="wp-image-50" srcset="http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0023.png 609w,http://www.defensivesec.net/wp-content/uploads/2019/07/GuestUser-0023-300x164.png 300w" sizes="(max-width: 609px) 100vw, 609px"></figure>



<pre class="wp-block-code"><code>{
    "type": "object",
    "properties": {
        "@@odata.context": {
            "type": "string"
        },
        "value": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "businessPhones": {
                        "type": "array"
                    },
                    "displayName": {
                        "type": "string"
                    },
                    "givenName": {},
                    "jobTitle": {},
                    "mail": {
                        "type": "string"
                    },
                    "mobilePhone": {},
                    "officeLocation": {},
                    "preferredLanguage": {},
                    "surname": {},
                    "userPrincipalName": {
                        "type": "string"
                    },
                    "id": {
                        "type": "string"
                    }
                },
                "required": [
                    "businessPhones",
                    "displayName",
                    "givenName",
                    "jobTitle",
                    "mail",
                    "mobilePhone",
                    "officeLocation",
                    "preferredLanguage",
                    "surname",
                    "userPrincipalName",
                    "id"
                ]
            }
        }
    }
}</code></pre>



<p>Hop on over to page 3 for more…</p>


<div class="page-links">Pages: <a href="http://www.defensivesec.net/2019/07/18/automating-azure-ad-b2b-invites-with-approval-workflow/" class="post-page-numbers">1</a> <span class="post-page-numbers current" aria-current="page">2</span> <a href="http://www.defensivesec.net/2019/07/18/automating-azure-ad-b2b-invites-with-approval-workflow/3/" class="post-page-numbers">3</a></div>					</div>

					<footer class="entry-footer">
											</footer>
				</article>

				
	<nav class="navigation post-navigation" role="navigation">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="http://www.defensivesec.net/2019/07/18/disappearing-windows-10-event-logs-after-feature-update/" rel="prev">Disappearing Windows 10 Event Logs After Feature Update</a></div></div>
	</nav>		</div>
		</main>

	</div>

        
	</div>

	<footer id="colophon" class="site-footer row" role="contentinfo">
		<div class="col-3">
		</div>
		<div class="col-9 site-info">
			<p></p>
			<p class="theme-by really-small"><a href="https://anguswoodman.com/simple-wordpress-themes" rel="designer">Theme by Angus Woodman</a></p>
		</div>
	</footer>
</div>


</div></body>
</html>
